var gdjs;(function(l){const c=1/(1<<16),E=o=>{o.metalness&&(o.metalness=0)},b=o=>{const t=o;if(!!t.material)if(Array.isArray(t.material))for(let e=0;e<t.material.length;e++)E(t.material[e]);else E(t.material)},O=o=>o.traverse(b),M=o=>{const t=new THREE.MeshBasicMaterial;return o.color&&(t.color=o.color),o.map&&(t.map=o.map),t},f=o=>{const t=o;if(!!t.material)if(Array.isArray(t.material))for(let e=0;e<t.material.length;e++)t.material[e]=M(t.material[e]);else t.material=M(t.material)},D=o=>o.traverse(f);class T extends l.RuntimeObject3DRenderer{constructor(t,e){const m=e.getGame().getModel3DManager().getModel(t._modelResourceName),a=new THREE.Group,i=new THREE.Group;i.rotation.order="ZYX",i.add(a);super(t,e,i);this._model3DRuntimeObject=t,this._threeObject=a,this._originalModel=m,this._modelOriginPoint=[0,0,0],this.updateSize(),this.updatePosition(),this.updateRotation(),this._animationMixer=new THREE.AnimationMixer(a),this._action=null}updateAnimation(t){this._animationMixer.update(t)}updatePosition(){const t=this.getOriginPoint(),e=this.getCenterPoint();this.get3DRendererObject().position.set(this._object.getX()-this._object.getWidth()*(t[0]-e[0]),this._object.getY()-this._object.getHeight()*(t[1]-e[1]),this._object.getZ()-this._object.getDepth()*(t[2]-e[2]))}getOriginPoint(){return this._model3DRuntimeObject._originPoint||this._modelOriginPoint}getCenterPoint(){return this._model3DRuntimeObject._centerPoint||this._modelOriginPoint}stretchModelIntoUnitaryCube(t,e,m,a){t.rotation.set(l.toRad(e),l.toRad(m),l.toRad(a)),t.updateMatrixWorld(!0);const i=new THREE.Box3().setFromObject(t);!this._model3DRuntimeObject._originPoint&&i.expandByPoint(new THREE.Vector3(0,0,0));const d=i.max.x-i.min.x,s=i.max.y-i.min.y,n=i.max.z-i.min.z,r=this._model3DRuntimeObject._centerPoint;r&&t.position.set(-(i.min.x+d*r[0]),-(i.min.y+s*(1-r[1])),-(i.min.z+n*r[2])),t.scale.set(1,1,1),t.rotation.set(l.toRad(e),l.toRad(m),l.toRad(a));const h=d<c?1:1/d,_=s<c?1:1/s,g=n<c?1:1/n,p=new THREE.Matrix4;return p.makeScale(h,-_,g),t.updateMatrix(),t.applyMatrix4(p),i}_updateDefaultTransformation(t,e,m,a,i,u,d,s){const n=this.stretchModelIntoUnitaryCube(t,e,m,a),r=n.max.x-n.min.x,h=n.max.y-n.min.y,_=n.max.z-n.min.z;if(this._modelOriginPoint[0]=r<c?0:-n.min.x/r,this._modelOriginPoint[1]=h<c?0:-n.min.y/h,this._modelOriginPoint[2]=_<c?0:-n.min.z/_,this._modelOriginPoint[1]=1-this._modelOriginPoint[1],s){const g=r<c?Number.POSITIVE_INFINITY:i/r,p=h<c?Number.POSITIVE_INFINITY:u/h,j=_<c?Number.POSITIVE_INFINITY:d/_;let R=Math.min(g,p,j);Number.isFinite(R)||(R=1),this._object._setOriginalWidth(R*r),this._object._setOriginalHeight(R*h),this._object._setOriginalDepth(R*_)}else this._object._setOriginalWidth(i),this._object._setOriginalHeight(u),this._object._setOriginalDepth(d)}_reloadModel(t,e){this._originalModel=e.getGame().getModel3DManager().getModel(t._modelResourceName)}_updateModel(t,e,m,a,i,u,d){const s=new THREE.Group;s.rotation.order="ZYX";const n=THREE_ADDONS.SkeletonUtils.clone(this._originalModel.scene);s.add(n),this._replaceMaterials(s),this._updateDefaultTransformation(s,t,e,m,a,i,u,d),this.get3DRendererObject().remove(this._threeObject),this.get3DRendererObject().add(s),this._threeObject=s,this.updatePosition(),this._updateShadow(),this._animationMixer=new THREE.AnimationMixer(n);const r=this._model3DRuntimeObject.isAnimationPaused();this._model3DRuntimeObject.setAnimationIndex(this._model3DRuntimeObject.getAnimationIndex()),r&&this.pauseAnimation()}_replaceMaterials(t){this._model3DRuntimeObject._materialType===l.Model3DRuntimeObject.MaterialType.StandardWithoutMetalness?O(t):this._model3DRuntimeObject._materialType===l.Model3DRuntimeObject.MaterialType.Basic&&D(t)}getAnimationCount(){return this._originalModel.animations.length}getAnimationName(t){return this._originalModel.animations[t].name}_updateShadow(){this._threeObject.traverse(t=>{t.castShadow=this._model3DRuntimeObject._isCastingShadow,t.receiveShadow=this._model3DRuntimeObject._isReceivingShadow})}hasAnimationEnded(){return this._action?!this._action.isRunning():!0}animationPaused(){if(!!this._action)return this._action.paused}pauseAnimation(){!this._action||(this._action.paused=!0)}resumeAnimation(){!this._action||(this._action.paused=!1)}playAnimation(t,e,m=!1){const a=THREE.AnimationClip.findByName(this._originalModel.animations,t);if(!a){console.error(`The GLB file: ${this._model3DRuntimeObject._modelResourceName} doesn't have any animation named: ${t}`);return}const i=this._action;this._action=this._animationMixer.clipAction(a),this._action.reset(),this._action.setLoop(e?THREE.LoopRepeat:THREE.LoopOnce,Number.POSITIVE_INFINITY),this._action.clampWhenFinished=!0,this._action.timeScale=this._model3DRuntimeObject.getAnimationSpeedScale(),i&&i!==this._action&&!m&&this._action.crossFadeFrom(i,this._model3DRuntimeObject._crossfadeDuration,!1),this._action.play(),this._animationMixer.update(0)}getAnimationElapsedTime(){return this._action?this._action.time:0}setAnimationElapsedTime(t){this._action&&(this._action.time=t)}setAnimationTimeScale(t){this._action&&(this._action.timeScale=t)}getAnimationDuration(t){const e=THREE.AnimationClip.findByName(this._originalModel.animations,t);return e?e.duration:0}}l.Model3DRuntimeObjectRenderer=T})(gdjs||(gdjs={}));
//# sourceMappingURL=Model3DRuntimeObject3DRenderer.js.map
